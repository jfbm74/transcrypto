{% extends 'base.html' %}

{% block title %}Configuración de API - App de Transcripción{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Configuración de la API de OpenAI</h4>
            </div>
            <div class="card-body">
                <p>Para utilizar la aplicación, necesitas configurar tu clave de API de OpenAI.</p>
                
                <div class="mb-3">
                    <label for="apiKey" class="form-label">Clave de API de OpenAI</label>
                    <input type="password" class="form-control" id="apiKey" placeholder="sk-...">
                    <div class="form-text">
                        Tu clave de API se almacenará temporalmente en esta sesión. No se guarda permanentemente en nuestros servidores.
                    </div>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" id="saveApiKey">Guardar clave de API</button>
                </div>
                
                <div class="alert alert-success mt-3 d-none" id="successMessage">
                    Clave de API guardada correctamente
                </div>
                
                <div class="alert alert-danger mt-3 d-none" id="errorMessage">
                    Error al guardar la clave de API
                </div>
            </div>
            <div class="card-footer text-muted">
                <p class="mb-0">¿No tienes una clave de API? <a href="https://platform.openai.com/api-keys" target="_blank">Obtén una en OpenAI</a></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const apiKeyInput = document.getElementById('apiKey');
        const saveButton = document.getElementById('saveApiKey');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Función para guardar la clave de API
        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                errorMessage.textContent = 'Por favor, introduce una clave de API válida';
                errorMessage.classList.remove('d-none');
                successMessage.classList.add('d-none');
                return;
            }
            
            // Ocultar mensajes anteriores
            successMessage.classList.add('d-none');
            errorMessage.classList.add('d-none');
            
            // Enviar la clave de API al servidor
            fetch('{{ url_for("set_api_key") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    successMessage.textContent = data.message;
                    successMessage.classList.remove('d-none');
                    
                    // Redirigir a la página principal después de 2 segundos
                    setTimeout(() => {
                        window.location.href = '{{ url_for("index") }}';
                    }, 2000);
                } else {
                    errorMessage.textContent = data.error;
                    errorMessage.classList.remove('d-none');
                }
            })
            .catch(error => {
                errorMessage.textContent = 'Error de conexión: ' + error;
                errorMessage.classList.remove('d-none');
            });
        }
        
        // Evento para el botón de guardar
        saveButton.addEventListener('click', saveApiKey);
        
        // Permitir enviar con Enter
        apiKeyInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveApiKey();
            }
        });
    });
</script>
{% endblock %}